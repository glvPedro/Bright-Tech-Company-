<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="dashboard.css" />
  <title>dashboard</title>
</head>

<body>
  <!-- DIV MENU LATERAL -->
  <div class="fundo">
    <div class="menulateral">
      <ul>
        <li style="background-color: white; border-radius: 10px">
          <a href="" style="color: #115639">
            <span class="icon">
              <ion-icon name="stats-chart-outline"></ion-icon>
            </span>
            <span class="menu">Gráficos</span>
          </a>
        </li>

        <li>
          <a href="">
            <span class="icon">
              <ion-icon name="person-outline"></ion-icon>
            </span>
            <span class="menu">Perfil</span>
          </a>
        </li>

        <li>
          <a href="">
            <span class="icon">
              <ion-icon name="notifications-outline"></ion-icon>
            </span>
            <span class="menu">Notificações</span>
          </a>
        </li>

        <li>
          <a href="">
            <span class="icon">
              <ion-icon name="chatbubbles-outline"></ion-icon>
            </span>
            <span class="menu">Mensagens</span>
          </a>
        </li>

        <li>
          <a href="">
            <span class="icon">
              <ion-icon name="help-circle-outline"></ion-icon>
            </span>
            <span class="menu">Ajuda</span>
          </a>
        </li>

        <li>
          <a href="login.html">
            <span class="icon">
              <ion-icon name="log-out-outline"></ion-icon>
            </span>
            <span class="menu">Sair</span>
          </a>
        </li>
      </ul>
      <div id="img_logo">
        <img src="./assents/1 1 (1).png" alt="" width="100%" />
      </div>
    </div>

    <!--DASHBOARD  -->
    <div class="dashboard">
      <!-- KPIS  -->
      <div class="analise">
        <div class="container2">
          <br />
          <!------------------------------------------------------------------------------------------->
          <div id="kpi">
            <span class="title">FLUXO</span>
            <div class="caixa">
              <div class="box">
                <p class="description">Diário</p>
                <br />
                <p class="description">Fluxo > 15</p>
                <br />
                <p class="sub-description">Capturado durante 30 minutos</p>
                <br />
                → É recomendado manter a iluminação em 100% neste perído de 30
                minutos.
              </div>
            </div>
          </div>
          <!------------------------------------------------------------------------------------------->
          <div id="kpi">
            <span class="title">MAIOR FLUXO</span>
            <div class="caixa">
              <div class="box">
                <p class="description">Semanal</p>
                <br />
                <br />
                <p class="description">Segunda-feira</p>
                <br />
                <p class="description">Quarta-feira</p>
                <br />
                <p class="description">Sexta-feira</p>
                <br />
              </div>
            </div>
          </div>
          <!------------------------------------------------------------------------------------------->
          <div id="kpi">
            <span class="title">MENOR FLUXO</span>

            <div class="caixa">
              <div class="box">
                <p class="description">Semanal</p>
                <br /><br />
                <p class="description">Terça-feira</p>
                <br />
                <p class="description">Quinta-feira</p>
                <br />
              </div>
            </div>
          </div>
          <!------------------------------------------------------------------------------------------->
          <div id="kpi">
            <span class="title">PARÂMETROS</span>
            <div class="container3">
              <br />
              <div class="box3">0 | 5 | 10 | 15 | 20 | 25></div>

              <div>
                * Dado as métricas acima, em caso de anormalidade acione os
                planos de ação para cada situação expecífica
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GRAFICOS -->

      <div class="container">
        <div id="caixa">
          <div class="grafico">
            <div id="legenda">
              <div id="legenda">DIÁRIO</div>
              <select name="dias_semanais" id="slc_id" onchange="slc_dias()">
                <option value="segunda">Segunda-Feira</option>
                <option value="terca">Terça-Feira</option>
                <option value="quarta">Quarta-Feira</option>
                <option value="quinta">Quinta-Feira</option>
                <option value="sexta">Sexta-Feira</option>
              </select>

              <select name="dias_setores" id="slc_id2" onchange="slc_dias2()">
                <option value="administrativo">Administrativo</option>
                <option value="financeiro">Financeiro</option>
                <option value="rh">Recursos Humanos</option>
                <option value="comercial">Comercial</option>
                <option value="ti">Tecnologia da Informação</option>
              </select>
            </div>
            <div id="grafics">
              <canvas id="myChart"></canvas>
            </div>
          </div>
        </div>

        <div id="caixa">
          <div class="grafico">
            <div id="legenda">SEMANAL</div>
            <div id="legenda">
              <select name="dias_setores" id="slc_id3" onchange="obterDadosGrafico(idEmpresa)">
                <option value="administrativo">Administrativo</option>
                <option value="financeiro">Financeiro</option>
                <option value="rh">Recursos Humanos</option>
                <option value="comercial">Comercial</option>
                <option value="ti">Tecnologia da Informação</option>
              </select>
            </div>
            <div id="grafics">
              <canvas id="myChart2"></canvas>
            </div>
          </div>

          <div id="p_legenda">

          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>

</html>

<script>
  const labels = [
    "06:00",
    "07:00",
    "08:00",
    "09:00",
    "10:00",
    "11:00",
    "12:00",
    "13:00",
    "14:00",
    "15:00",
    "16:00",
    "17:00",
    "18:00",
    "19:00",
    "20:00",
    "21:00",
    "22:00",
  ];

  var data = {
    labels: labels,
    datasets: [
      {
        label: "fluxo por setor - administrativo (04/10/2022)",
        backgroundColor: "rgb(0, 77, 0)",
        borderColor: "rgb(0, 77, 0)",
        data: [5, 2, 10, 8, 15, 12, 27, 32, 16, 14, 20, 18, 25, 22, 30, 21, 17],
      },
    ],
  };

  var config = {
    type: "bar",
    data: data,
    options: {},
  };
</script>

<script>
  var idEmpresa = sessionStorage.getItem('ID_EMPRESA')

  window.onload = obterDadosGrafico(idEmpresa);

  var myChart = new Chart(document.getElementById("myChart"), config);

  function obterDadosGrafico(id) {
    var dia = slc_id3.value;

    fetch(`/medidas/ultimas`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        id,
        dia
      })
    }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(resposta)
          plotarGrafico(resposta, id);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }
  function plotarGrafico(resposta, id) {
    console.log('iniciando plotagem do gráfico...');

    let labels = ['5 dias', '4 dias', '3 dias', '2 dias', 'atual'];
    const dados = {
      labels: labels,
      datasets: [
        {
          label: "fluxo de pessoas - empresa (administrativo)",
          backgroundColor: "rgb(0, 77, 0)",
          borderColor: "rgb(0, 77, 0)",
          data: [],
        },
      ],
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      dados.datasets[0].data.push(registro.media);
      console.log(registro.media)
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets[0].data2)
    console.log('----------------------------------------------')

    const config2 = {
      type: "line",
      data: dados,
      options: {},
    };
    
    let myChart2 = new Chart(
      document.getElementById('myChart2'),
      config2
    );
  }

  function atualizarGrafico(id, dados, myChart) {

    fetch(`/medidas/tempo-real/${id}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico:`);
          console.log(dados);
          document.getElementById("avisoCaptura").innerHTML = ""

          if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
            console.log("Horário do novo dado capturado:")
            console.log(novoRegistro[0].momento_grafico)
            console.log("Horário do último dado capturado:")
            console.log(dados.labels[dados.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {

            dados.labels.shift();
            dados.labels.push(novoRegistro[0].momento_grafico);

            dados.datasets[0].data.shift();
            dados.datasets[0].data.push(novoRegistro[0].umidade);

            dados.datasets[1].data.shift();
            dados.datasets[1].data.push(novoRegistro[0].temperatura);

            myChart.update();
          }

          proximaAtualizacao = setTimeout(() => atualizarGrafico(id, dados, myChart), 2000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        proximaAtualizacao = setTimeout(() => atualizarGrafico(id, dados, myChart), 2000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }
</script>